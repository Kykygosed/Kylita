<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Radio Web</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
    }

    h1 {
      color: #00ffcc;
    }

    select, input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      font-size: 1em;
    }

    #log {
      background: #222;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      width: 350px;
      font-size: 0.9em;
    }

    button {
      cursor: pointer;
      border: none;
    }

    #connectBtn {
      background: #00ffcc;
      color: black;
    }

    #toggleMic {
      background: #444;
      color: white;
    }
  </style>
</head>
<body>
  <h1>üõ©Ô∏è Radio Web</h1>
  <input id="freqInput" placeholder="Fr√©quence (ex: 123.45)" />
  
  <select id="inputSelect"></select>
  <select id="outputSelect"></select>
  
  <button id="connectBtn">Connexion</button>
  <button id="toggleMic" disabled>üéôÔ∏è Micro OFF</button>

  <div id="log"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
  authDomain: "kylita-f2923.firebaseapp.com",
  databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
  projectId: "kylita-f2923",
  storageBucket: "kylita-f2923.firebasestorage.app",
  messagingSenderId: "431823530994",
  appId: "1:431823530994:web:88a07e633751686e5ad96b",
  measurementId: "G-F4LLNWQJ16"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let localStream = null;
    let selectedInputId = null;
    let selectedOutputId = null;
    let peers = {};
    let roomId = "";
    let micOn = false;
    const userId = "user_" + Math.random().toString(36).substring(2, 9);

    const freqInput = document.getElementById("freqInput");
    const inputSelect = document.getElementById("inputSelect");
    const outputSelect = document.getElementById("outputSelect");
    const connectBtn = document.getElementById("connectBtn");
    const toggleMic = document.getElementById("toggleMic");
    const log = document.getElementById("log");

    function addLog(msg) {
      log.innerHTML += `<div>> ${msg}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    async function listAudioDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      inputSelect.innerHTML = '';
      outputSelect.innerHTML = '';

      devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `${device.kind} ${device.deviceId}`;
        if (device.kind === 'audioinput') inputSelect.appendChild(option);
        if (device.kind === 'audiooutput') outputSelect.appendChild(option);
      });

      selectedInputId = inputSelect.value;
      selectedOutputId = outputSelect.value;

      inputSelect.onchange = () => selectedInputId = inputSelect.value;
      outputSelect.onchange = () => selectedOutputId = outputSelect.value;
    }

    listAudioDevices();

    connectBtn.onclick = async () => {
      roomId = freqInput.value.trim().replace(/\./g, "_");
      if (!roomId) return alert("Entrer une fr√©quence valide.");

      addLog("Connexion √† la fr√©quence " + roomId);
      connectBtn.disabled = true;
      freqInput.disabled = true;
      toggleMic.disabled = false;

      localStream = await navigator.mediaDevices.getUserMedia({
        audio: { deviceId: selectedInputId ? { exact: selectedInputId } : undefined }
      });

      localStream.getAudioTracks()[0].enabled = false;

      const roomRef = db.ref("radio/" + roomId);
      const userRef = roomRef.child(userId);
      userRef.onDisconnect().remove();

      roomRef.on("child_added", async snapshot => {
        const otherId = snapshot.key;
        if (otherId === userId || peers[otherId]) return;

        const pc = createPeerConnection(otherId);
        peers[otherId] = pc;

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        db.ref(`signals/${roomId}/${otherId}/${userId}`).set({ offer });
      });

      roomRef.on("child_removed", snapshot => {
        const id = snapshot.key;
        if (peers[id]) {
          peers[id].close();
          delete peers[id];
          addLog(`${id} d√©connect√©.`);
        }
      });

      userRef.set(true);

      db.ref("signals/" + roomId + "/" + userId).on("child_added", async snap => {
        const from = snap.key;
        const data = snap.val();

        let pc = peers[from];
        if (!pc) {
          pc = createPeerConnection(from);
          peers[from] = pc;
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }

        if (data.offer) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          db.ref(`signals/${roomId}/${from}/${userId}`).set({ answer });
        } else if (data.answer) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.candidate) {
          pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      });
    };

    toggleMic.onclick = () => {
      micOn = !micOn;
      if (localStream) {
        localStream.getAudioTracks()[0].enabled = micOn;
        toggleMic.textContent = micOn ? "üéôÔ∏è Micro ON" : "üéôÔ∏è Micro OFF";
        toggleMic.style.background = micOn ? "#00cc66" : "#444";
        addLog(micOn ? "Micro activ√©" : "Micro d√©sactiv√©");
      }
    };

    function createPeerConnection(remoteId) {
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      pc.onicecandidate = event => {
        if (event.candidate) {
          db.ref(`signals/${roomId}/${remoteId}/${userId}`).push({
            candidate: event.candidate.toJSON()
          });
        }
      };

      pc.ontrack = event => {
        const remoteStream = event.streams[0];
        const audio = document.createElement("audio");
        audio.srcObject = remoteStream;
        audio.autoplay = true;
        audio.controls = false;

        if ('setSinkId' in audio && selectedOutputId) {
          audio.setSinkId(selectedOutputId).then(() => {
            addLog("Sortie audio d√©finie !");
          }).catch(err => {
            addLog("Erreur setSinkId: " + err);
          });
        }

        document.body.appendChild(audio);
        addLog(`Flux re√ßu de ${remoteId}`);
      };

      return pc;
    }
  </script>
</body>
</html>
