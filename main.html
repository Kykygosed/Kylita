<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Radio Fr√©quence</title>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: white;
      text-align: center;
      padding: 30px;
    }
    select, input, button {
      margin: 10px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>üéß Fr√©quence Radio</h1>
  <input type="text" id="frequencyInput" placeholder="Entrez une fr√©quence..." />
  <br>
  <select id="audioInputSelect"></select>
  <select id="audioOutputSelect"></select>
  <br>
  <button id="joinBtn">Rejoindre la fr√©quence</button>
  <br><br>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
    // --- Config Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
      authDomain: "kylita-f2923.firebaseapp.com",
      databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
      projectId: "kylita-f2923",
      storageBucket: "kylita-f2923.appspot.com",
      messagingSenderId: "431823530994",
      appId: "1:431823530994:web:88a07e633751686e5ad96b",
      measurementId: "G-F4LLNWQJ16"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Variables ---
    const userId = Math.random().toString(36).substring(2, 9);
    let currentFrequency = '';
    let localStream;
    let peerConnections = {};

    // --- S√©lecteurs ---
    const inputSelect = document.getElementById("audioInputSelect");
    const outputSelect = document.getElementById("audioOutputSelect");
    const remoteAudio = document.getElementById("remoteAudio");

    navigator.mediaDevices.enumerateDevices().then(devices => {
      devices.forEach(device => {
        if (device.kind === "audioinput") {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.text = device.label || `Microphone ${inputSelect.length + 1}`;
          inputSelect.appendChild(option);
        } else if (device.kind === "audiooutput") {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.text = device.label || `Haut-parleur ${outputSelect.length + 1}`;
          outputSelect.appendChild(option);
        }
      });
    });

    // Appliquer sortie audio
    outputSelect.addEventListener("change", () => {
      if (typeof remoteAudio.setSinkId === "function") {
        remoteAudio.setSinkId(outputSelect.value).catch(err => console.error("Erreur setSinkId", err));
      }
    });

    // Rejoindre une fr√©quence
    document.getElementById("joinBtn").addEventListener("click", async () => {
      currentFrequency = document.getElementById("frequencyInput").value.trim();
      if (!currentFrequency) return alert("Entrez une fr√©quence.");

      localStream = await navigator.mediaDevices.getUserMedia({
        audio: { deviceId: inputSelect.value ? { exact: inputSelect.value } : undefined }
      });

      const freqRef = db.ref(`frequencies/${currentFrequency}`);
      const usersRef = freqRef.child("users");

      usersRef.on("child_added", async snap => {
        const otherId = snap.key;
        if (otherId === userId) return;

        const pc = createPeerConnection(otherId);
        peerConnections[otherId] = pc;

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        setTimeout(() => {
          db.ref(`frequencies/${currentFrequency}/offers/${userId}/${otherId}`).set(pc.localDescription.toJSON());
        }, 500);
      });

      db.ref(`frequencies/${currentFrequency}/offers`).on("child_added", snap => {
        const fromId = snap.key;
        if (fromId === userId) return;

        db.ref(`frequencies/${currentFrequency}/offers/${fromId}/${userId}`).on("value", async snap => {
          if (!snap.exists()) return;
          const offer = new RTCSessionDescription(snap.val());

          const pc = createPeerConnection(fromId);
          peerConnections[fromId] = pc;

          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

          await pc.setRemoteDescription(offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);

          setTimeout(() => {
            db.ref(`frequencies/${currentFrequency}/answers/${userId}/${fromId}`).set(pc.localDescription.toJSON());
          }, 500);
        });
      });

      db.ref(`frequencies/${currentFrequency}/answers`).on("child_added", snap => {
        const fromId = snap.key;
        if (fromId === userId) return;

        db.ref(`frequencies/${currentFrequency}/answers/${fromId}/${userId}`).on("value", async snap => {
          if (!snap.exists()) return;
          const answer = new RTCSessionDescription(snap.val());
          const pc = peerConnections[fromId];
          if (!pc.currentRemoteDescription) {
            await pc.setRemoteDescription(answer);
          }
        });
      });

      // S'inscrire
      usersRef.child(userId).set(true);
      usersRef.child(userId).onDisconnect().remove();
    });

    function createPeerConnection(remoteId) {
      const pc = new RTCPeerConnection();

      pc.ontrack = event => {
        const remoteStream = new MediaStream();
        remoteStream.addTrack(event.track);
        remoteAudio.srcObject = remoteStream;
      };

      pc.onicecandidate = event => {
        if (event.candidate) {
          db.ref(`frequencies/${currentFrequency}/candidates/${userId}/${remoteId}`).push(event.candidate.toJSON());
        }
      };

      db.ref(`frequencies/${currentFrequency}/candidates/${remoteId}/${userId}`).on("child_added", snap => {
        if (!snap.exists()) return;
        pc.addIceCandidate(new RTCIceCandidate(snap.val()));
      });

      return pc;
    }
  </script>
</body>
</html>

