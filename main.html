<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Radio Fréquence</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0e0e0e;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #interface {
      background: #1c1c1c;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      width: 300px;
      text-align: center;
    }
    input, select, button {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      border: none;
      border-radius: 8px;
    }
    button {
      background-color: #4caf50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <div id="interface">
    <h2>Fréquence radio</h2>
    <input id="freq" placeholder="Ex: 123.45" />
    <select id="inputSelect"></select>
    <select id="outputSelect"></select>
    <button onclick="joinFreq()">Connexion</button>
    <button id="toggleMic">Activer le micro</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
      authDomain: "kylita-f2923.firebaseapp.com",
      databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
      projectId: "kylita-f2923",
      storageBucket: "kylita-f2923.appspot.com",
      messagingSenderId: "431823530994",
      appId: "1:431823530994:web:88a07e633751686e5ad96b",
      measurementId: "G-F4LLNWQJ16"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let localStream;
    let connections = {};
    let myFreq = null;
    let myId = Math.random().toString(36).substring(2);

    async function listDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const audioInputs = devices.filter(d => d.kind === 'audioinput');
      const audioOutputs = devices.filter(d => d.kind === 'audiooutput');

      const inputSelect = document.getElementById('inputSelect');
      const outputSelect = document.getElementById('outputSelect');
      inputSelect.innerHTML = '';
      outputSelect.innerHTML = '';

      audioInputs.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `Micro ${inputSelect.length+1}`;
        inputSelect.appendChild(option);
      });

      audioOutputs.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `Sortie ${outputSelect.length+1}`;
        outputSelect.appendChild(option);
      });
    }

    listDevices();

    async function joinFreq() {
      myFreq = document.getElementById("freq").value.replace(/[^0-9.]/g, "");
      if (!myFreq) return alert("Entrez une fréquence valide.");
      const inputId = document.getElementById("inputSelect").value;
      localStream = await navigator.mediaDevices.getUserMedia({ audio: { deviceId: inputId ? { exact: inputId } : undefined } });

      const freqRef = ref(db, `freqs/${myFreq}`);

      onChildAdded(freqRef, async (snap) => {
        const data = snap.val();
        if (data.from === myId) return;
        const blob = new Blob([new Uint8Array(data.audio)], { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        const sinkId = document.getElementById("outputSelect").value;
        if (audio.setSinkId && sinkId) {
          try { await audio.setSinkId(sinkId); } catch(e) { console.warn("Impossible de changer de sortie audio", e); }
        }
        audio.play();
      });
    }

    document.getElementById("toggleMic").addEventListener("click", () => {
      if (!localStream) return alert("Connecte-toi d'abord à une fréquence.");
      const recorder = new MediaRecorder(localStream);
      recorder.ondataavailable = async e => {
        if (e.data.size > 0) {
          const arrayBuffer = await e.data.arrayBuffer();
          push(ref(db, `freqs/${myFreq}`), {
            from: myId,
            audio: Array.from(new Uint8Array(arrayBuffer))
          });
        }
      };
      recorder.start(1000); // envoie toutes les secondes
    });
  </script>
</body>
</html>

