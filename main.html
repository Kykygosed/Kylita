<!DOCTYPE html>
<html>
<head>
  <title>Kylita</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #2c2c2c, #4b4b4b);
      color: white;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      flex-shrink: 0;
    }
    #logo {
      font-size: 36px;
      font-weight: bold;
    }
    #userBox {
      background: #3a3a3a;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: bold;
    }
    #playlists {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      padding: 20px;
      flex-grow: 1;
      box-sizing: border-box;
    }
    .playlist-box {
      background: #3a3a3a;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    #createBtn {
      display: block;
      margin: 10px auto 30px auto;
      background: orange;
      border: none;
      padding: 15px 30px;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      flex-shrink: 0;
    }
    #nowPlaying {
      background: orange;
      border-radius: 15px;
      margin: 0 20px 20px 20px;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    .bottom-bar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #2c2c2c;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      flex-shrink: 0;
    }
    .bottom-bar button {
      background: orange;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: orange;
      padding: 30px;
      border-radius: 20px;
      color: black;
      z-index: 9999;
      display: none;
      min-width: 300px;
      box-sizing: border-box;
    }
    .popup h2 { margin-top: 0; }
    .popup ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
    }
    .popup ul li {
      margin: 5px 0;
    }
    .popup .closeBtn, .popup .playBtn, .popup .saveBtn {
      margin-top: 10px;
      padding: 10px;
      background: #fff;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      min-width: 80px;
    }
    /* Popup spécifique création playlist */
    #createPlaylistPopup input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      margin-top: 15px;
      box-sizing: border-box;
    }
    #createPlaylistPopup .buttonRow {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <header>
    <div id="logo">Kylita</div>
    <div id="userBox">Chargement...</div>
  </header>

  <div id="playlists"></div>

  <button id="createBtn">+ Créer une playlist</button>

  <div id="nowPlaying">Aucun son en cours</div>

  <div class="bottom-bar">
    <button onclick="location.href='home.html'">Accueil</button>
    <button onclick="location.href='search.html'">Rechercher</button>
  </div>

  <!-- Popup détails playlist -->
  <div class="popup" id="playlistPopup">
    <h2 id="popupTitle">Nom de la playlist</h2>
    <button class="playBtn">▶ Lancer</button>
    <button class="closeBtn" onclick="closePlaylistPopup()">Fermer</button>
    <ul id="popupTracks"></ul>
  </div>

  <!-- Popup création playlist -->
  <div class="popup" id="createPlaylistPopup">
    <h2>Créer une playlist</h2>
    <input type="text" id="newPlaylistName" placeholder="Nom de la playlist" />
    <div class="buttonRow">
      <button class="saveBtn" id="savePlaylistBtn">Créer</button>
      <button class="closeBtn" id="cancelCreateBtn">Annuler</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    // Ta config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
      authDomain: "kylita-f2923.firebaseapp.com",
      databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
      projectId: "kylita-f2923",
      storageBucket: "kylita-f2923.firebasestorage.app",
      messagingSenderId: "431823530994",
      appId: "1:431823530994:web:88a07e633751686e5ad96b",
      measurementId: "G-F4LLNWQJ16"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const userBox = document.getElementById('userBox');
    const playlistsDiv = document.getElementById('playlists');
    const createBtn = document.getElementById('createBtn');
    const playlistPopup = document.getElementById('playlistPopup');
    const createPlaylistPopup = document.getElementById('createPlaylistPopup');
    const newPlaylistNameInput = document.getElementById('newPlaylistName');
    const savePlaylistBtn = document.getElementById('savePlaylistBtn');
    const cancelCreateBtn = document.getElementById('cancelCreateBtn');
    let playlists = [];
    let userId;

    function closePlaylistPopup() {
      playlistPopup.style.display = "none";
    }
    function openPlaylistPopup(name, tracks) {
      document.getElementById("popupTitle").innerText = name;
      const list = document.getElementById("popupTracks");
      list.innerHTML = "";
      tracks.forEach(track => {
        const li = document.createElement("li");
        li.innerText = track;
        list.appendChild(li);
      });
      playlistPopup.style.display = "block";
    }

    function refreshPlaylists() {
      playlistsDiv.innerHTML = "";
      for (let i = 0; i < 6; i++) {
        const div = document.createElement('div');
        div.className = 'playlist-box';
        if (playlists[i]) {
          div.innerText = playlists[i].name;
          div.onclick = () => openPlaylistPopup(playlists[i].name, playlists[i].tracks || []);
        } else {
          div.innerText = 'Emplacement vide';
          div.style.cursor = 'default';
        }
        playlistsDiv.appendChild(div);
      }
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        userId = user.uid;
        const userRef = ref(db, `users/${userId}`);
        get(userRef).then(snapshot => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            userBox.innerText = userData.name || user.email;
            playlists = userData.playlists || [];
            refreshPlaylists();
          } else {
            userBox.innerText = user.email;
            playlists = [];
            refreshPlaylists();
          }
        });
      } else {
        userBox.innerText = "Non connecté";
        playlists = [];
        refreshPlaylists();
      }
    });

    createBtn.onclick = () => {
      newPlaylistNameInput.value = "";
      createPlaylistPopup.style.display = "block";
      newPlaylistNameInput.focus();
    }

    cancelCreateBtn.onclick = () => {
      createPlaylistPopup.style.display = "none";
    }

    savePlaylistBtn.onclick = () => {
      const name = newPlaylistNameInput.value.trim();
      if (!name) {
        alert("Veuillez entrer un nom valide.");
        return;
      }
      // Ajouter la playlist localement
      playlists.push({name: name, tracks: []});
      // Enregistrer dans Firebase
      set(ref(db, `users/${userId}/playlists`), playlists).then(() => {
        refreshPlaylists();
        createPlaylistPopup.style.display = "none";
      }).catch(err => {
        alert("Erreur lors de la sauvegarde : " + err.message);
      });
    }
  </script>
</body>
</html>
