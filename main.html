<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Kydollar - Virements</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb') no-repeat center center fixed;
      background-size: cover;
      color: white;
    }

    .button {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 15px 25px;
      text-align: center;
      font-size: 1.1em;
      border-radius: 20px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .button:hover {
      background-color: #0056b3;
    }

    .form-container {
      display: none;
      margin-bottom: 20px;
    }

    input {
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-right: 10px;
      width: 150px;
    }

    #fortune {
      font-size: 1.3em;
      margin-bottom: 20px;
      background: rgba(0,0,0,0.4);
      padding: 15px;
      border-radius: 10px;
    }

    .notification-card {
      background: rgba(255, 255, 255, 0.1);
      border-left: 5px solid #00ccff;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }
  </style>
</head>
<body>

  <button class="button" id="toggleForm">+ Nouveau virement</button>

  <div class="form-container" id="formContainer">
    <input type="text" id="receiver" placeholder="Pseudo destinataire">
    <input type="text" id="amount" placeholder="Montant (ex: 15.50)">
    <button class="button" id="sendBtn">Envoyer</button>
  </div>

  <div id="fortune">Votre fortune: <span id="balance">0.00 ‡</span></div>

  <h3>Notifications :</h3>
  <div id="notifications"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
      authDomain: "kylita-f2923.firebaseapp.com",
      projectId: "kylita-f2923",
      databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
      storageBucket: "kylita-f2923.appspot.com",
      messagingSenderId: "431823530994",
      appId: "1:431823530994:web:88a07e633751686e5ad96b",
      measurementId: "G-F4LLNWQJ16"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    const pseudo = localStorage.getItem("pseudo");

    if (!pseudo) {
      alert("Utilisateur non connecté !");
      window.location.href = "index.html";
    }

    const balanceSpan = document.getElementById("balance");
    const formContainer = document.getElementById("formContainer");
    const notificationsDiv = document.getElementById("notifications");

    document.getElementById("toggleForm").addEventListener("click", () => {
      formContainer.style.display = formContainer.style.display === "none" ? "block" : "none";
    });

    // Affichage de la fortune en temps réel
    const balanceRef = db.ref("users/" + pseudo + "/balance");
    balanceRef.on("value", (snap) => {
      const balance = snap.val() || 0;
      balanceSpan.innerText = `${parseFloat(balance).toFixed(2)} ‡`;
    });

    // Notifications en temps réel
    const notifRef = db.ref("users/" + pseudo + "/notifications");
    notifRef.on("child_added", (snap) => {
      const text = snap.val();
      const div = document.createElement("div");
      div.className = "notification-card";
      div.innerText = text;
      notificationsDiv.prepend(div);
    });

    // Envoi d’un virement
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const receiver = document.getElementById("receiver").value.trim();
      const amountStr = document.getElementById("amount").value.trim();
      const amount = parseFloat(amountStr);

      if (!receiver || isNaN(amount) || amount <= 0) {
        alert("Entrez un destinataire valide et un montant positif.");
        return;
      }

      const senderRef = db.ref("users/" + pseudo);
      const receiverRef = db.ref("users/" + receiver);

      const senderSnap = await senderRef.once("value");
      const senderData = senderSnap.val();

      if (!senderData || senderData.balance === undefined) {
        alert("Erreur : votre compte n’a pas de solde.");
        return;
      }

      const currentBalance = parseFloat(senderData.balance);

      if (currentBalance < amount) {
        alert("Vous n'avez pas assez de Kydollars.");
        return;
      }

      const receiverSnap = await receiverRef.once("value");
      if (!receiverSnap.exists()) {
        alert("Le destinataire n’existe pas.");
        return;
      }

      // Mise à jour des soldes
      await senderRef.update({
        balance: (currentBalance - amount).toFixed(2)
      });

      const receiverBalance = parseFloat(receiverSnap.val().balance || 0);
      await receiverRef.update({
        balance: (receiverBalance + amount).toFixed(2)
      });

      const timestamp = Date.now();

      // Notifications
      await db.ref("users/" + pseudo + "/notifications/" + timestamp).set(`Vous avez fait un virement de ${amount.toFixed(2)} ‡ à ${receiver}.`);
      await db.ref("users/" + receiver + "/notifications/" + timestamp).set(`Vous avez reçu un virement de ${amount.toFixed(2)} ‡ de la part de ${pseudo} !`);

      document.getElementById("receiver").value = "";
      document.getElementById("amount").value = "";
    });
  </script>

</body>
</html>
