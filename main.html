<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Talkie WebRTC - Fréquence</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #eee;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
  }
  #login, #room {
    background: #333;
    padding: 20px;
    border-radius: 8px;
    width: 320px;
    box-sizing: border-box;
  }
  input, select, button {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    font-size: 1rem;
    border-radius: 4px;
    border: none;
  }
  button {
    background: #28a745;
    color: white;
    cursor: pointer;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #users {
    margin-top: 10px;
    font-size: 0.9rem;
  }
  #micToggle {
    margin-top: 15px;
    background: #dc3545;
  }
</style>
</head>
<body>

<div id="login">
  <h2>Rejoindre une fréquence</h2>
  <input type="text" id="freqInput" placeholder="Ex: 12380 (pas de . ni de #)" maxlength="10" />
  <button id="joinBtn">Rejoindre</button>
</div>

<div id="room" style="display:none;">
  <h2>Fréquence: <span id="currentFreq"></span></h2>
  
  <label for="inputSelect">Micro (entrée) :</label>
  <select id="inputSelect"></select>

  <label for="outputSelect">Haut-parleurs (sortie) :</label>
  <select id="outputSelect"></select>

  <button id="micToggle">Micro ON</button>
  
  <div id="users">
    <strong>Participants connectés:</strong>
    <ul id="userList"></ul>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // --- CONFIGURATION FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
    authDomain: "kylita-f2923.firebaseapp.com",
    databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
    projectId: "kylita-f2923",
    storageBucket: "kylita-f2923.firebasestorage.app",
    messagingSenderId: "431823530994",
    appId: "1:431823530994:web:88a07e633751686e5ad96b",
    measurementId: "G-F4LLNWQJ16"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- VARIABLES GLOBALES ---
  let pc;
  let localStream;
  let remoteStream = new MediaStream();
  let freqRef;       // Référence Firebase pour la fréquence
  let myId;          // ID unique (timestamp + random)
  let freq;
  let micEnabled = true;

  // Elements HTML
  const loginDiv = document.getElementById('login');
  const roomDiv = document.getElementById('room');
  const freqInput = document.getElementById('freqInput');
  const joinBtn = document.getElementById('joinBtn');
  const currentFreqSpan = document.getElementById('currentFreq');
  const inputSelect = document.getElementById('inputSelect');
  const outputSelect = document.getElementById('outputSelect');
  const micToggleBtn = document.getElementById('micToggle');
  const userList = document.getElementById('userList');

  // Génère un ID unique simple
  function generateId() {
    return Date.now().toString() + '_' + Math.floor(Math.random() * 100000);
  }

  // --- Gestion des périphériques ---
  async function enumerateDevices() {
    const devices = await navigator.mediaDevices.enumerateDevices();

    // Entrées audio
    inputSelect.innerHTML = '';
    devices.filter(d => d.kind === 'audioinput').forEach(d => {
      const option = document.createElement('option');
      option.value = d.deviceId;
      option.text = d.label || `Microphone ${inputSelect.length + 1}`;
      inputSelect.appendChild(option);
    });

    // Sorties audio
    outputSelect.innerHTML = '';
    devices.filter(d => d.kind === 'audiooutput').forEach(d => {
      const option = document.createElement('option');
      option.value = d.deviceId;
      option.text = d.label || `Haut-parleur ${outputSelect.length + 1}`;
      outputSelect.appendChild(option);
    });
  }

  // Applique la sortie audio sur l'élément audio distant
  function setAudioOutput(deviceId) {
    if ('setSinkId' in remoteAudio) {
      remoteAudio.setSinkId(deviceId).catch(e => console.warn('Erreur setSinkId:', e));
    } else {
      console.warn('setSinkId non supporté par ce navigateur.');
    }
  }

  // --- Création de la PeerConnection ---
  function createPeerConnection() {
    const servers = {
      iceServers: [
        {urls: "stun:stun.l.google.com:19302"},
      ]
    };
    const connection = new RTCPeerConnection(servers);

    connection.onicecandidate = e => {
      if (e.candidate) {
        freqRef.child('candidates').child(myId).push(e.candidate.toJSON());
      }
    };

    connection.ontrack = e => {
      remoteStream.addTrack(e.track);
    };

    return connection;
  }

  // --- Start local audio stream ---
  async function startLocalStream(deviceId) {
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
    }
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: {deviceId: deviceId ? {exact: deviceId} : undefined},
      video: false
    });
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  // --- Nettoyage Firebase + PeerConnection ---
  async function cleanUp() {
    if (pc) {
      pc.close();
      pc = null;
    }
    if (freqRef) {
      await freqRef.child('participants').child(myId).remove();
      await freqRef.child('candidates').child(myId).remove();
      await freqRef.child('offers').child(myId).remove();
      await freqRef.child('answers').child(myId).remove();
    }
  }

  // --- Rejoins la fréquence ---
  async function joinFrequency(chosenFreq) {
    freq = chosenFreq;
    myId = generateId();
    freqRef = db.ref('frequencies/' + freq);

    // Ajoute participant
    await freqRef.child('participants').child(myId).set(true);

    // Montre la fréquence et cache login
    currentFreqSpan.textContent = freq;
    loginDiv.style.display = 'none';
    roomDiv.style.display = 'block';

    // Crée la PeerConnection
    pc = createPeerConnection();

    // Crée la balise audio distante pour écouter
    remoteAudio.srcObject = remoteStream;
    remoteAudio.play();

    // Commence la capture audio locale avec premier micro sélectionné
    await startLocalStream(inputSelect.value);

    updateUserList();

    // Écoute les candidats entrants
    freqRef.child('candidates').on('child_added', snapshot => {
      const userId = snapshot.key;
      if (userId === myId) return; // Ignore toi-même
      snapshot.forEach(candidateSnap => {
        const candidate = candidateSnap.val();
        pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
      });
    });

    // Écoute les offres
    freqRef.child('offers').on('child_added', async snapshot => {
      const offerUserId = snapshot.key;
      if (offerUserId === myId) return;
      const offerData = snapshot.val();

      if (pc.signalingState !== "stable") return;

      await pc.setRemoteDescription(new RTCSessionDescription(offerData));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await freqRef.child('answers').child(myId).set(answer);

    });

    // Écoute les réponses
    freqRef.child('answers').on('child_added', async snapshot => {
      const answerUserId = snapshot.key;
      if (answerUserId === myId) return;
      const answerData = snapshot.val();

      if (pc.signalingState === "have-local-offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(answerData));
      }
    });

    // Lorsque l'interface demande la connexion, crée une offre
    joinBtn.disabled = true;
  }

  // --- Met à jour la liste des participants ---
  async function updateUserList() {
    freqRef.child('participants').on('value', snapshot => {
      const participants = snapshot.val() || {};
      userList.innerHTML = '';
      Object.keys(participants).forEach(id => {
        const li = document.createElement('li');
        li.textContent = id === myId ? `${id} (Vous)` : id;
        userList.appendChild(li);
      });
    });
  }

  // --- Gestion du bouton micro ---
  micToggleBtn.onclick = () => {
    if (!localStream) return;
    micEnabled = !micEnabled;
    localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
    micToggleBtn.textContent = micEnabled ? 'Micro ON' : 'Micro OFF';
  };

  // --- Gestion du changement de périphérique entrée ---
  inputSelect.onchange = async () => {
    if (!pc) return;
    await startLocalStream(inputSelect.value);
    micEnabled = true;
    micToggleBtn.textContent = 'Micro ON';
  };

  // --- Gestion du changement de sortie audio ---
  outputSelect.onchange = () => {
    setAudioOutput(outputSelect.value);
  };

  // --- Initialisation ---
  async function init() {
    await enumerateDevices();
  }

  // --- Evénement bouton rejoindre ---
  joinBtn.onclick = async () => {
    let val = freqInput.value.trim();
    // Nettoyage fréquence pour enlever points, #, $, [, ]
    val = val.replace(/[.#$\[\]]/g, '');
    if (!val) {
      alert('Fréquence invalide (ne doit pas contenir ., #, $, [, ])');
      return;
    }
    await joinFrequency(val);
  };

  // --- Création élément audio distant (invisible) ---
  const remoteAudio = document.createElement('audio');
  remoteAudio.autoplay = true;
  remoteAudio.controls = false;
  remoteAudio.style.display = 'none';
  document.body.appendChild(remoteAudio);

  window.onload = init;

  // Nettoyage quand l'utilisateur quitte la page
  window.onbeforeunload = cleanUp;

</script>

</body>
</html>



