<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Kylita - Rechercher un son</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: sans-serif;
      padding: 20px;
    }
    input, button, select {
      padding: 10px;
      margin: 5px;
      border: none;
      border-radius: 5px;
    }
    .result {
      background-color: #1e1e1e;
      padding: 15px;
      margin-top: 10px;
      border-radius: 10px;
    }
    .playlist-select {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ðŸ”Ž Rechercher un son</h1>
  <input type="text" id="searchInput" placeholder="Titre ou artiste...">
  <button onclick="search()">Rechercher</button>
  <div id="results"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, push, onValue
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
      authDomain: "kylita-f2923.firebaseapp.com",
      databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
      projectId: "kylita-f2923",
      storageBucket: "kylita-f2923.appspot.com",
      messagingSenderId: "431823530994",
      appId: "1:431823530994:web:88a07e633751686e5ad96b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let currentUser = null;
    let userPlaylists = {};

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        const playlistsRef = ref(db, 'users/' + user.uid + '/playlists');
        onValue(playlistsRef, snapshot => {
          userPlaylists = snapshot.val() || {};
        });
      }
    });

    async function search() {
      const query = document.getElementById("searchInput").value;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "Chargement...";

      const res = await fetch(`https://archive.org/advancedsearch.php?q=${encodeURIComponent(query)}+AND+mediatype:(audio)&fl[]=identifier,title,creator&rows=10&page=1&output=json`);
      const data = await res.json();
      resultsDiv.innerHTML = "";

      for (const doc of data.response.docs) {
        const audioURL = `https://archive.org/download/${doc.identifier}/${doc.identifier}_64kb.mp3`;

        const div = document.createElement("div");
        div.className = "result";
        div.innerHTML = `
          <h3>${doc.title}</h3>
          <p>${doc.creator || "Inconnu"}</p>
          <audio controls src="${audioURL}"></audio>
          <br>
          <button onclick='showPlaylistDropdown(${JSON.stringify({
            title: doc.title,
            artist: doc.creator || "Inconnu",
            url: audioURL
          })})'>âž• Ajouter Ã  une playlist</button>
        `;
        resultsDiv.appendChild(div);
      }
    }

    window.showPlaylistDropdown = (track) => {
      const dropdown = document.createElement("select");
      dropdown.className = "playlist-select";
      dropdown.innerHTML = '<option disabled selected>Choisir une playlist</option>';

      for (let name in userPlaylists) {
        const option = document.createElement("option");
        option.value = name;
        option.innerText = name;
        dropdown.appendChild(option);
      }

      dropdown.onchange = () => {
        const selectedPlaylist = dropdown.value;
        if (!currentUser) return alert("Non connectÃ©.");

        const refPath = `users/${currentUser.uid}/playlists/${selectedPlaylist}`;
        push(ref(db, refPath), track);
        alert(`AjoutÃ© Ã  la playlist ${selectedPlaylist} !`);
        dropdown.remove();
      };

      document.body.appendChild(dropdown);
    }
  </script>
</body>
</html>
