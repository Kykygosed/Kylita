<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche - Kylita</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: linear-gradient(120deg, #1d1f27, #3a3d4a);
      color: white;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.4);
    }

    h1 {
      margin: 0;
      font-size: 2rem;
    }

    .search-bar {
      width: 100%;
      padding: 1rem;
      box-sizing: border-box;
    }

    .search-bar input {
      width: 100%;
      padding: 1rem;
      font-size: 1.2rem;
      border-radius: 10px;
      border: none;
    }

    .results {
      padding: 1rem;
    }

    .result {
      background: #2c3e50;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .result-title {
      font-weight: bold;
    }

    .result-artist {
      font-style: italic;
    }

    .audio-controls {
      margin-top: 0.5rem;
    }

    .playlist-select {
      margin-top: 0.5rem;
      display: none;
    }

    select, button {
      margin-top: 5px;
      padding: 5px 10px;
      border-radius: 5px;
      border: none;
    }

    button:hover {
      cursor: pointer;
      background: #3498db;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <h1>Kylita</h1>
    <div id="user-info">Compte</div>
  </header>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Rechercher un son...">
  </div>

  <div class="results" id="results"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // CONFIG FIREBASE KYLITA
    const firebaseConfig = {
      apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
      authDomain: "kylita-f2923.firebaseapp.com",
      databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
      projectId: "kylita-f2923",
      storageBucket: "kylita-f2923.appspot.com",
      messagingSenderId: "431823530994",
      appId: "1:431823530994:web:88a07e633751686e5ad96b",
      measurementId: "G-F4LLNWQJ16"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("results");

    let playlists = {};

    // Charger les playlists une seule fois
    firebase.database().ref("playlists").on("value", (snap) => {
      playlists = snap.val() || {};
    });

    searchInput.addEventListener("input", async () => {
      const query = searchInput.value.trim();
      if (!query) {
        resultsDiv.innerHTML = "";
        return;
      }

      const response = await fetch(`https://archive.org/advancedsearch.php?q=${encodeURIComponent(query)}+AND+(format:mp3+OR+format:ogg+OR+format:mp4)&fl[]=identifier&rows=10&page=1&output=json`);
      const data = await response.json();

      resultsDiv.innerHTML = "";

      for (const doc of data.response.docs) {
        const id = doc.identifier;
        const meta = await fetch(`https://archive.org/metadata/${id}`).then(r => r.json());
        const files = meta.files.filter(f => f.name.endsWith(".mp3") || f.name.endsWith(".m4a") || f.name.endsWith(".ogg"));

        if (files.length === 0) continue;

        const file = files[0];
        const url = `https://archive.org/download/${id}/${file.name}`;
        const title = meta.metadata.title || file.name;
        const artist = meta.metadata.creator || "Inconnu";

        const div = document.createElement("div");
        div.className = "result";
        div.innerHTML = `
          <div class="result-title">${title}</div>
          <div class="result-artist">${artist}</div>
          <div class="audio-controls">
            <audio controls src="${url}" preload="none"></audio><br>
            <button class="add-to-playlist">Ajouter à une playlist</button>
            <div class="playlist-select">
              <select>
                ${Object.keys(playlists).map(p => `<option value="${p}">${p}</option>`).join("")}
              </select>
              <button class="confirm-add">OK</button>
            </div>
          </div>
        `;

        // Bouton "Ajouter à une playlist"
        const btn = div.querySelector(".add-to-playlist");
        const dropdown = div.querySelector(".playlist-select");
        btn.onclick = () => {
          dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        };

        // Bouton OK dans la sélection
        const okBtn = div.querySelector(".confirm-add");
        okBtn.onclick = () => {
          const select = div.querySelector("select");
          const chosen = select.value;
          if (!chosen) return;
          firebase.database().ref("playlists/" + chosen).push({ url, title, artist });
          alert(`Ajouté à la playlist "${chosen}"`);
          dropdown.style.display = "none";
        };

        resultsDiv.appendChild(div);
      }
    });
  </script>
</body>
</html>
